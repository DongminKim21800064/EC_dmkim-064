# LAB: Input Capture - Ultrasonic 

**Date:** 2022-11-10

**Author/Partner:** DongMin Kim / Jinho Guk

**Github:**  https://github.com/DongminKim21800064/EC_dmkim-064

**Demo Video:**  https://www.youtube.com/watch?v=gZgYWWAU3Kk

# Introduction

In this lab, you are required to create a simple program that uses input capture mode to measure the distance using an ultrasonic distance sensor. The sensor also needs trigger pulses that can be generated by using the timer output.



# Requirement

##### Hardware

- MCU

  - NUCLEO-F411RE
- Actuator

  - HC-SR04

- Others
  - breadboard

#####  Software

- Keil uVision, CMSIS, EC_HAL library



# Problem 1: Create HAL library

### Create HAL library

Declare and Define the following functions in your library. You must update your header files located in the directory `EC \lib\`.

**ecTIM.h**

```c
// IC structure
typedef struct{
	GPIO_TypeDef *port;
	int pin;   
	TIM_TypeDef *timer;
	int ch;  		//int Timer Channel
	int ICnum;  //int IC number
} IC_t;

// ICAP setup
void ICAP_init(IC_t *ICx, GPIO_TypeDef *port, int pin);		// Initialize input capture mode (default setting)
void ICAP_setup(IC_t *ICx, int IC_number, int edge_type);	// Setup ICn and Edge type
void ICAP_counter_us(IC_t *ICx, int usec);

// ICAP flag
uint32_t is_CCIF(TIM_TypeDef *TIMx, uint32_t ccNum);
void clear_CCIF(TIM_TypeDef *TIMx, uint32_t ccNum);
```



# Problem 2: Ultrasonic Distance Sensor (HC-SR04)

The HC-SR04 ultrasonic distance sensor. This economical sensor provides 2cm to 400cm of non-contact measurement functionality with a ranging accuracy that can reach up to 3mm. Each HC-SR04 module includes an ultrasonic transmitter, a receiver and a control circuit.

![HC-SR04](https://user-images.githubusercontent.com/91526930/198864049-3dba8f8d-aec8-4f9a-8da3-9adc0fe0e4b9.png)

**The HC-SR04 Ultrasonic Range Sensor Features:**

- Input Voltage: 5V
- Current Draw: 20mA (Max)
- Digital Output: 5V
- Digital Output: 0V (Low)
- Sensing Angle: 30° Cone
- Angle of Effect: 15° Cone
- Ultrasonic Frequency: 40kHz
- Range: 2cm - 400cm

### Procedure

1. Create a new project under the directory `\repos\EC\LAB\LAB_Timer_InputCaputre_Ultrasonic`

- The project name is “**LAB_Timer_InputCaputre_Ultrasonic”.**
- Create a new source file named as “**LAB_Timer_InputCaputre_Ultrasonic.c”**

> You MUST write your name on the source file inside the comment section.

2. Include your updated library in `\repos\EC\lib\` to your project.

- **ecGPIO.h, ecGPIO.c**
- **ecRCC.h, ecRCC.c**
- **ecTIM.h, ecTIM.c**
- **ecPWM.h, ecPWM.c**
- **ecUART.h, ecUART.c**
- **ecSysTick.h, ecSysTick.c**

3. Connect the HC-SR04 ultrasonic distance sensor to MCU pins(PA6 - trigger, PB10 - echo), VCC and GND

### Measurement of Distance

The program needs to

- Generate a trigger pulse as PWM to the sensor.

- Receive echo pulses from the ultrasonic sensor

- Measure the distance by calculating pulse-width of the echo pulse.

- Display measured distance in [cm] on serial monitor of Tera-Term for

  (a) 10cm (b) 50cm (c) 100cm

###  Configuration

| System Clock | PWM                                       | Input Capture                                                |
| ------------ | ----------------------------------------- | ------------------------------------------------------------ |
| PLL (84MHz)  | PA6 (TIM3_CH1)                            | PB10 (TIM2_CH3)                                              |
|              | AF, Push-Pull, No Pull-up Pull-down, Fast | AF, No Pull-up Pull-down                                     |
|              | PWM period: 50msec pulse width: 10usec    | Counter Clock : 0.1MHz (10us) TI3 -> IC3 (rising edge) TI3 -> IC4 (falling edge) |

### Circuit Diagram
![image](https://user-images.githubusercontent.com/91419683/200917742-a1f920ec-907d-4a59-bbfe-c3cc023d15dc.png)



### Discussion

1. There can be an over-capture case, when a new capture interrupt occurs before reading the CCR value. When does it occur and how can you calculate the time span accurately between two captures?

> In order to handle the overcapture, it is recommended to read the data before the overcapture flag. This is to avoid missing an overcapture which could happen after reading the flag and before reading the data.

2. In the tutorial, what is the accuracy when measuring the period of 1Hz square wave? Show your result.

> -

### Code

Your code goes here:(https://github.com/DongminKim21800064/EC_dmkim-064/blob/main/lab/EC_LAB%20Input%20Capture_Ultrasonic_21800064_%EA%B9%80%EB%8F%99%EB%AF%BC/LAB_TImer_InputCapture_Ultrasonic.c)

Explain your source code with necessary comments.

**LAB_Timer_InputCapture_Ultrasonic.c**

```c
#include "stm32f411xe.h"
#include "math.h"
#include "ecGPIO.h"
#include "ecRCC.h"
#include "ecTIM.h"
#include "ecPWM.h"
#include "ecUART.h"
#include "ecSystick.h"

void TIM2_IRQHandler(void);

uint32_t ovf_cnt = 0;
double distance = 0;
double timeInterval = 0;
double time1 = 0;
double time2= 0;
static volatile int flag = 0;

void setup(void);

int main(void){
	
	setup();
	
	
	while(1){
	  
	if(flag>=5){ 				// For ignore Initial sensor malfunction
			distance = ( timeInterval*340/(2*1000000) ) * 100; // ( timeInterval[us]*340[m/s]/(2*1000000) ) * 100 ==> distance[cm]
		if(distance>=(2-0.3) && distance<=(400+0.3)){ // Measurement : 2cm to 400cm, Ranging Accuracy : +-3mm
			printf("%f [cm]\r\n", distance);
			delay_ms(500);
			flag = 5;
			}
		}
	}
}
void TIM2_IRQHandler(void){
	if(is_UIF(TIM2)){                   // Update interrupt
		ovf_cnt++;												// overflow count
		clear_UIF(TIM2);  						    // clear update interrupt flag
	}
	if(is_CCIF(TIM2, 3)){ 							// TIM2_Ch3 (IC3) Capture Flag. Rising Edge Detect
		time1 = TIM2->CCR3;								// Capture TimeStart from CC3

		clear_CCIF(TIM2, 3);              // clear capture/compare interrupt flag 
	}								                      
	else if(is_CCIF(TIM2, 4)){ 					// TIM2_Ch3 (IC4) Capture Flag. Falling Edge Detect
		flag++;
		time2 = TIM2->CCR4;								// Capture TimeEnd from CC4

		timeInterval = ( (time2 - time1) + ( (TIM2->ARR) + 1 )*ovf_cnt ) * 10; 		// Total time of echo pulse
		
		ovf_cnt = 0;                      // overflow reset
		clear_CCIF(TIM2, 4);							// clear capture/compare interrupt flag 
	}
}

void setup(){

	RCC_PLL_init(); 
	SysTick_init(1);
	UART2_init();
  
// PWM configuration ---------------------------------------------------------------------	
	PWM_t trig;											// PWM1 for trig
	
	PWM_init(&trig,GPIOA,PA6);			 // PWM init as PA_6: Ultrasonic trig puls
	PWM_period_us(&trig,50000);    	// PWM of 50ms period. Use period_us()
	PWM_pulsewidth_us(&trig,10);   	// PWM pulse width of 10us

// Input Capture configuration -----------------------------------------------------------------------	
	IC_t echo;											// Input Capture for echo
	ICAP_init(&echo,GPIOB,PB10);    // ICAP init as PB10 as input caputre
	ICAP_counter_us(&echo, 10);   	// ICAP counter step time as 10us
	ICAP_setup(&echo, 3, RISE);   	// TIM2_CH3 as IC3 , rising edge detect
	ICAP_setup(&echo, 4, FALL);			// TIM2_CH3 as IC4 , falling edge detect

// Enable TIMx interrupt			-----------------------------------------------------------------------	

	TIM_INT_enable(TIM2);  					// TIM2 Interrupt Enable

}

```
#### Code discription
**main**
If the IC4 Falling Edge detected more than five time, so that flag >= 5, "distance" equal like the code. Distance equal that ( timeInterval*sonic/(2*1000000) ) * 100. Second if statement in main function is for remove extraordinary numbers. The range specification of our sensor is 2cm ~ 400cm and +-3mm. So if distance is low than 1.7cm or 400.3cm, it will be extraordinary numbers.

**TIM2_IRQHandler**
Update intterupt in TIM2, and count the overflow. Measure the start time and final time for calculate the timeInterval.

**setup**
Regarding to the Lab description, I set up.

### Results

Experiment images and results
![IMG_8897 1](https://user-images.githubusercontent.com/91419683/200922078-6dc30965-02ea-4c87-86f2-454d4750837b.JPG)


demo video link : https://www.youtube.com/watch?v=gZgYWWAU3Kk

## Reference

Given Data : https://ykkim.gitbook.io/ec/course/lab/lab-input-capture-ultrasonic



## Troubleshooting
Two problems occurred while proceeding with Problem2. The first is that there were many errors in the initial measurement value immediately after reset. The second was that a very large distance was measured during the measurement process. 
First, to solve the first problem, I reduced the initial value error by using 'flag' to output the distance value from the total occurrence of interrupt more than 5 times. In order to solve the second problem, the output was only made when the measurement value was within (2cm-3mm) to (400cm+3mm). It was based on the specification of the ultrasonic sensor.
![image](https://user-images.githubusercontent.com/91419683/200925357-1e91ff95-72be-4cd3-9cd4-5411183630a2.png)
